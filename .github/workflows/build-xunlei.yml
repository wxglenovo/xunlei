name: Build Xunlei for ImmortalWrt (x86_64)

on:
  workflow_dispatch:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
            g++-multilib gettext git libncurses-dev libssl-dev python3-setuptools \
            python3-pip rsync unzip zlib1g-dev xz-utils

      - name: Detect latest ImmortalWrt release
        id: detect
        run: |
          BASE_URL="https://downloads.immortalwrt.org/releases"

          echo "Fetching release list ..."
          RELEASE=$(curl -s $BASE_URL/ | grep -oE '24\.[0-9]+\.[0-9]+' | sort -V | tail -1)

          echo "Latest release: $RELEASE"
          echo "release=$RELEASE" >> $GITHUB_OUTPUT

      - name: Download SDK
        run: |
          RELEASE=${{ steps.detect.outputs.release }}
          SDK_URL="https://downloads.immortalwrt.org/releases/${RELEASE}/targets/x86/64/"
          echo "Checking SDK under $SDK_URL"

          FILE=$(curl -s $SDK_URL | grep -o 'immortalwrt-sdk-.*\.tar\.xz' | head -1)

          if [ -z "$FILE" ]; then
             echo "‚ùå ERROR: SDK not found!"
             exit 1
          fi

          FULL_URL="${SDK_URL}${FILE}"
          echo "Downloading: $FULL_URL"

          wget "$FULL_URL"
          tar -xf "$FILE"
          mv immortalwrt-sdk-* sdk

      - name: Prepare Xunlei & Luci source
        run: |
          cd sdk/package
          git clone https://github.com/sbwml/luci-app-xunlei.git
          git clone https://github.com/gngpp/xunlei.git

      - name: Update feeds
        run: |
          cd sdk
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Compile packages
        run: |
          cd sdk
          make defconfig
          make package/xunlei/compile V=s
          make package/luci-app-xunlei/compile V=s

      - name: Collect Outputs
        run: |
          mkdir output
          find sdk/bin/targets -name "*.ipk" -exec cp {} output/ \;
          cd output
          zip xunlei_x86_64_packages.zip *.ipk

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: xunlei-${{ steps.detect.outputs.release }}
          name: Xunlei build for ImmortalWrt ${{ steps.detect.outputs.release }}
          draft: false
          prerelease: false
          files: |
            output/*.ipk
            output/*.zip
